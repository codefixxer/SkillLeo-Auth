<!-- page 5 -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Portfolio Projects - ProMatch</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <style>
    :root {
      /* Design tokens */
      --primary: #0061FF;
      --dark: #000000;
      --white: #FFFFFF;
  
      --gray-900: #111111;
      --gray-700: #404040;
      --gray-500: #737373;
      --gray-300: #E5E7EB;
      --gray-100: #F9FAFB;
  
      --error: #EF4444;
      --success: #10B981;
  
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-md: 0 8px 24px rgba(0,0,0,0.08);
      --shadow-lg: 0 12px 40px rgba(0,0,0,0.12);
    }
  
    :root{
      --primary: #0066CC;
      --primary-hover: #0052A3;
      --secondary: #F3F6FF;
      --accent: #00A0DC;
      --text-primary: #1D2129;
      --text-secondary: #65676B;
      --text-muted: #8A8D91;
      --bg: #FFFFFF;
      --bg-secondary: #F8F9FA;
      --border: #DADDE1;
      --border-light: #E4E6EA;
      --success: #42B883;
      --danger: #EF4444;
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
      --shadow-md: 0 4px 20px rgba(0,0,0,0.12);
      --shadow-lg: 0 8px 40px rgba(0,0,0,0.15);
      --gradient: linear-gradient(135deg, #0066CC 0%, #00A0DC 100%);
      --gradient-light: linear-gradient(135deg, rgba(0, 102, 204, 0.1) 0%, rgba(0, 160, 220, 0.1) 100%);
    }

    /* Reset */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      color: var(--gray-900);
      background: var(--white);
      -webkit-font-smoothing: antialiased;
      line-height: 1.5;
      overflow-x: hidden;
    }
  
    /* Background (particles canvas + floating shapes) */
    .bg-canvas {
      position: fixed; inset: 0; width: 100%; height: 100%;
      z-index: -1; opacity: 0.02;
    }
    .bg-decoration {
      position: fixed; inset: 0; width: 100%; height: 100%;
      pointer-events: none; z-index: -2;
    }
    .floating-shape {
      position: absolute; border-radius: 50%; will-change: transform, opacity; filter: blur(6px);
      background:
        radial-gradient(circle at 30% 30%, rgba(0, 97, 255, 0.22), rgba(0, 97, 255, 0.10) 45%, transparent 65%),
        radial-gradient(circle at 70% 70%, rgba(0, 97, 255, 0.18), transparent 60%);
      animation: floatBlob 14s ease-in-out infinite; opacity: .6;
    }
    .floating-shape:nth-child(1){ --size:280px; width:var(--size); height:var(--size); top:10%; right:12%; animation-delay:0s; }
    .floating-shape:nth-child(2){ --size:200px; width:var(--size); height:var(--size); bottom:20%; left:8%; animation-delay:4.2s; }
    .floating-shape:nth-child(3){ --size:150px; width:var(--size); height:var(--size); top:56%; right:28%; animation-delay:8.4s; }
    @keyframes floatBlob {
      0%,100% { transform: translate3d(0,0,0) scale(1) rotate(0deg); opacity: .55; }
      25%     { transform: translate3d(-12px,-22px,0) scale(1.03) rotate(8deg); opacity: .65; }
      50%     { transform: translate3d(0,-14px,0) scale(.98) rotate(0deg); opacity: .60; }
      75%     { transform: translate3d(12px,-28px,0) scale(1.04) rotate(-8deg); opacity: .68; }
    }
  
    /* Header */
    .header {
      position: fixed; top: 0; left: 0; right: 0;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--gray-300);
      z-index: 100;
    }
    .header__inner {
      max-width: 1200px; margin: 0 auto; padding: 16px 24px;
      display: flex; align-items: center; justify-content: space-between; min-height: 64px;
    }
    .logo { height: 28px; width: auto; display: block; }
  
    .progress-container { display: flex; align-items: center; gap: 12px; font-size: 13px; color: var(--gray-500); font-weight: 500; }
    .progress-bar { width: 120px; height: 6px; background: var(--gray-300); border-radius: 3px; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--dark); transition: width .6s ease; width: 62.5%; } /* step 5/8 */
  
    /* Layout */
    .container {
      max-width: 640px; margin: 0 auto;
      padding: 100px 24px 40px; /* space for fixed header */
      min-height: 100vh; display: flex; align-items: center;
    }
    .form-card {
      width: 100%; background: rgba(255,255,255,0.98); backdrop-filter: blur(20px);
      border: 1px solid var(--gray-300); border-radius: 16px; padding: 40px;
      box-shadow: var(--shadow-sm); animation: slideUp .6s ease-out;
    }
    @keyframes slideUp { from { opacity:0; transform: translateY(20px);} to { opacity:1; transform:none;} }
  
    .form-header { margin-bottom: 32px; }
    .step-badge {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 6px 14px; background: var(--gray-100); color: var(--gray-700);
      border-radius: 20px; font-size: 13px; font-weight: 500; margin-bottom: 16px;
    }
    .step-badge::before { content: ''; width: 6px; height: 6px; background: var(--primary); border-radius: 50%; animation: pulse 2s ease-in-out infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.5} }
  
    .form-title { font-size: 28px; font-weight: 700; color: var(--dark); margin-bottom: 8px; letter-spacing: -0.02em; }
    .form-subtitle { font-size: 15px; color: var(--gray-500); }
  
    /* Skip */
    .skip-section {
      background: var(--gray-100);
      border: 1px dashed var(--gray-300);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      margin-bottom: 20px;
      color: var(--gray-700);
      font-size: 14px;
    }
    .skip-btn {
      margin-top: 10px;
      background: var(--white);
      border: 1px solid var(--gray-300);
      color: var(--gray-700);
      padding: 10px 14px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;
      transition: all .2s ease;
    }
    .skip-btn:hover { border-color: var(--dark); background: var(--gray-100); color: var(--dark); }
    .skip-btn:focus-visible { outline: 3px solid rgba(0,97,255,.35); outline-offset: 2px; }
    .skip-btn:active { transform: translateY(0.5px); }
  
    /* Empty state */
    .projects-list { margin: 24px 0; }
    .empty-state {
      border: 2px dashed var(--gray-300);
      border-radius: 12px; padding: 28px; text-align: center; color: var(--gray-500); font-size: 14px;
    }
    .empty-state .empty-icon { font-size: 42px; margin-bottom: 8px; opacity: .7; }
    .empty-state .empty-title { font-weight: 700; color: var(--gray-900); margin-bottom: 4px; }
  
    /* Project cards */
    .project-card {
      border: 1px solid var(--gray-300);
      border-radius: 12px; padding: 20px; background: var(--white);
      box-shadow: 0 6px 20px rgba(0,0,0,0.03);
      position: relative; margin-bottom: 14px;
      transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease;
      animation: cardAppear .5s ease;
    }
    @keyframes cardAppear { from {opacity:0; transform: translateY(12px);} to {opacity:1; transform:none;} }
    .display-card { background: var(--gray-100); }
    .display-card:hover { transform: translateY(-1px); box-shadow: 0 10px 28px rgba(0,0,0,0.06); border-color: var(--gray-300); }
  
    .card-actions {
      position:absolute; top:10px; right:10px; display:flex; gap:8px; z-index:2;
      background: rgba(255,255,255,0.8); border:1px solid var(--gray-300); border-radius:10px; backdrop-filter: blur(6px); padding:4px;
    }
    .card-edit, .card-remove {
      width:30px; height:30px; display:inline-flex; align-items:center; justify-content:center;
      border:1px solid var(--gray-300); background: var(--white);
      border-radius:8px; cursor:pointer; transition: background .2s ease, color .2s ease, transform .15s ease, border-color .2s ease;
      line-height: 0;
    }
    .card-edit:hover { background: var(--dark); color: var(--white); border-color: var(--dark); }
    .card-edit:focus-visible, .card-remove:focus-visible { outline: 3px solid rgba(0,97,255,.35); outline-offset: 2px; }
    .card-remove { border-radius: 50%; color:#DC2626; background:#FEE2E2; border-color:#FCA5A5; }
    .card-remove:hover { background:#DC2626; color:#fff; border-color:#DC2626; }
    .card-remove:active, .card-edit:active { transform: translateY(0.5px); }
  
    .card-media {
      border-radius: 10px; overflow: hidden; margin-bottom: 12px;
      border: 1px solid var(--gray-300);
      background: linear-gradient(135deg, rgba(0,0,0,.03), rgba(0,0,0,.02));
    }
    .card-media .media-wrap { width: 100%; aspect-ratio: 16 / 9; background: var(--gray-100); display: block; }
    .card-media img { width: 100%; height: 100%; object-fit: cover; display:block; }
  
    .card-header { padding-right: 96px; margin-bottom: 10px; }
    .card-title { font-weight: 700; color: var(--gray-900); font-size: 16px; }
    .card-description { margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--gray-300); font-size: 14px; color: var(--gray-700); }
    .card-footer { display:flex; align-items:center; justify-content: space-between; padding-top: 10px; }
    .card-link { color: var(--primary); text-decoration: none; font-weight: 600; font-size: 13px; }
    .card-link:hover { text-decoration: underline; }
    .card-link:focus-visible { outline: 3px solid rgba(0,97,255,.35); outline-offset: 2px; border-radius: 4px; }
    .card-tech { font-size: 11px; color: var(--gray-500); background: var(--white); padding: 4px 8px; border-radius: 12px; border: 1px solid var(--gray-300); }
  
    /* Edit state + form controls */
    .edit-card { border: 1px solid var(--dark); }
    .form-group { margin-bottom: 16px; }
    .form-label { display:block; font-size:14px; font-weight:500; color: var(--gray-700); margin-bottom: 8px; }
    .required { color: var(--error); }
  
    .form-input, .form-textarea {
      width: 100%; padding: 12px 14px; border: 1px solid var(--gray-300); border-radius: 8px;
      font-size: 15px; font-family: inherit; background: var(--white); transition: all .2s ease; min-height: 44px;
    }
    .form-textarea { min-height: 96px; line-height: 1.6; resize: vertical; }
    .form-input:hover, .form-textarea:hover { border-color: #d1d5db; }
    .form-input:focus, .form-textarea:focus { outline: none; border-color: var(--dark); box-shadow: 0 0 0 3px rgba(0,0,0,0.05); }
    .form-input:focus-visible, .form-textarea:focus-visible { outline: 3px solid rgba(0,97,255,.35); outline-offset: 2px; }
    .char-count { text-align:right; font-size: 12px; color: var(--gray-500); margin-top: 6px; }
  
    /* AI helper */
    .ai-helper {
      margin-top: 16px; padding: 14px;
      background: rgba(0,97,255,0.06);
      border: 1px dashed rgba(0,97,255,0.35);
      border-radius: 12px; color: var(--gray-700); font-size: 14px;
    }
    .ai-actions { margin-top: 10px; display:flex; flex-wrap: wrap; gap: 8px; }
    .ai-button {
      background: var(--white); border: 2px solid var(--primary); color: var(--primary);
      padding: 10px 14px; border-radius: 10px; cursor: pointer; font-weight: 700; font-size: 13px;
      transition: transform .15s ease, background .2s ease, color .2s ease, box-shadow .2s ease;
    }
    .ai-button:hover:not(:disabled) { background: var(--primary); color: #fff; transform: translateY(-1px); box-shadow: var(--shadow-sm); }
    .ai-button:active:not(:disabled) { transform: translateY(0); }
    .ai-button:disabled { opacity: .5; cursor: not-allowed; }
  
    /* Image Upload (edit) */
    .img-dropzone {
      position: relative; border: 2px dashed var(--gray-300);
      border-radius: 12px; padding: 14px; background: var(--gray-100);
      transition: border-color .2s ease, background .2s ease; cursor: pointer;
    }
    .img-dropzone:hover { border-color: var(--dark); background: #F2F6FF; }
    .img-dropzone.dragover { border-color: var(--primary); background: rgba(0,97,255,0.06); }
    .img-dropzone .dz-inner {
      display: grid; grid-template-columns: 120px 1fr; gap: 14px; align-items: center;
    }
    .img-thumb {
      width: 120px; height: 80px; border-radius: 10px; overflow: hidden; border: 1px solid var(--gray-300);
      background: var(--white); display:flex; align-items:center; justify-content:center; font-size: 12px; color: var(--gray-500);
    }
    .img-thumb img { width: 100%; height: 100%; object-fit: cover; display:block; }
    .img-actions { display:flex; gap:8px; flex-wrap: wrap; }
    .img-btn {
      background: var(--white); border: 1px solid var(--gray-300); color: var(--gray-700);
      padding: 8px 12px; border-radius: 8px; font-weight: 700; font-size: 13px; cursor: pointer; transition: all .2s ease;
    }
    .img-btn:hover { background: var(--dark); color: #fff; border-color: var(--dark); }
    .img-btn:focus-visible { outline: 3px solid rgba(0,97,255,.35); outline-offset: 2px; }
    .img-hint { font-size: 12px; color: var(--gray-500); margin-top: 6px; }
  
    /* Footer actions + generic buttons */
    .form-actions {
      display: flex; justify-content: space-between; align-items: center;
      margin-top: 28px; padding-top: 20px; border-top: 1px solid var(--gray-300);
    }
  
    .btn {
      padding: 12px 24px; border-radius: 10px; font-weight: 700; font-size: 15px;
      cursor: pointer; border: none;
      display: inline-flex; align-items: center; gap: 8px;
      transition: transform .15s ease, box-shadow .2s ease, background .2s ease, color .2s ease, filter .2s ease;
    }
    .btn:focus-visible { outline: 3px solid rgba(0,97,255,.35); outline-offset: 2px; }
    .btn:active { transform: translateY(0.5px); }
  
    .btn-back {
      background: var(--white); color: var(--gray-700); border: 1px solid var(--gray-300);
    }
    .btn-back:hover { border-color: var(--gray-700); background: var(--gray-100); }
  
    .btn-primary {
      background: var(--dark); color: #fff; min-width: 120px; justify-content: center;
    }
    .btn-primary:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .btn-primary:disabled { opacity: .35; cursor: not-allowed; transform: none; }
  
    /* Contextual buttons used inside edit cards */
    .save-btn, .cancel-btn {
      padding: 10px 14px; border-radius: 10px; font-weight: 700; font-size: 13px; display: inline-flex; align-items: center; gap: 6px;
      transition: transform .15s ease, background .2s ease, color .2s ease, filter .2s ease;
    }
    .save-btn { background: var(--success); color: #fff; border: none; }
    .save-btn:hover { filter: brightness(0.95); transform: translateY(-1px); }
    .save-btn:active { transform: translateY(0); }
  
    .cancel-btn { background: var(--white); color: var(--gray-700); border: 1px solid var(--gray-300); }
    .cancel-btn:hover { background: var(--gray-100); }
    .save-btn:focus-visible, .cancel-btn:focus-visible { outline: 3px solid rgba(0,97,255,.35); outline-offset: 2px; }
  
    /* Loaders & toast */
    .loading-spinner {
      width: 16px; height: 16px; border: 2px solid transparent; border-top: 2px solid currentColor;
      border-radius: 50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  
    .toast {
      position: fixed; top: 20px; right: 20px; background: var(--dark); color: #fff;
      padding: 12px 16px; border-radius: 10px; font-size: 13px; box-shadow: var(--shadow-lg); z-index: 9999;
      animation: toastIn .2s ease;
    }
    @keyframes toastIn { from{opacity:0; transform: translateY(-6px);} to{opacity:1; transform:none;} }
  
    /* A11y helper */
    .sr-only {
      position: absolute !important; width:1px; height:1px; padding:0; margin:-1px;
      overflow:hidden; clip: rect(0,0,1px,1px); white-space:nowrap; border:0;
    }
  
    /* Mobile */
    @media (max-width: 640px) {
      .container { padding: 80px 16px 24px; }
      .form-card { padding: 32px 24px; }
      .form-title { font-size: 24px; }
      .form-actions { flex-direction: column-reverse; gap: 12px; }
      .btn { width: 100%; justify-content: center; }
      .floating-shape { opacity: .05; }
      .card-header { padding-right: 76px; }
      .img-dropzone .dz-inner { grid-template-columns: 1fr; }
      .img-thumb { width: 100%; height: 160px; }
    }




    /* Add Project Button */
    .add-project-btn {
      width: 100%;
      padding: 16px 24px;
      background: var(--gradient);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 32px;
      transition: all 0.3s ease;
    }

    .add-project-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

  </style>
  
  
</head>
<body>
  <!-- Animated Background -->
  <canvas class="bg-canvas" id="bgCanvas" aria-hidden="true"></canvas>
  <div class="bg-decoration" aria-hidden="true">
    <div class="floating-shape"></div>
    <div class="floating-shape"></div>
    <div class="floating-shape"></div>
  </div>

  <!-- Header -->
  <header class="header">
    <div class="header__inner">
      <picture>
        <source media="(max-width: 768px)" srcset="../logos/rm-bg/icon1.png"/>
        <img class="logo" src="../logos/rm-bg/logo1.png" alt="ProMatch"/>
      </picture>

      <div class="progress-container" aria-live="polite">
        <span id="stepText">Step 5 of 8</span>
        <div class="progress-bar" aria-hidden="true">
          <div class="progress-fill" id="headerProgress"></div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="container">
    <section class="form-card" aria-labelledby="portfolio-title">
      <div class="form-header">
        <div class="step-badge">Portfolio Projects</div>
        <h1 class="form-title" id="portfolio-title">Showcase your best work</h1>
        <p class="form-subtitle">Add projects that demonstrate your skills and impact.</p>
      </div>

      <form id="portfolioForm" novalidate>
        <!-- Skip -->
        <div class="skip-section">
          Portfolio is optional but highly recommended for better visibility.
          <div>
            <button type="button" class="skip-btn" id="skipBtn">Skip for now</button>
          </div>
        </div>

        <!-- Projects -->
        <div class="projects-list" id="projectsList">
          <div class="empty-state" id="emptyState">
            <div class="empty-icon">🎯</div>
            <div class="empty-title">Add your first project</div>
            <div class="empty-subtitle">Showcase work that demonstrates your expertise</div>
          </div>
        </div>

        <!-- Add button -->
        <button type="button" class="add-project-btn" id="addBtn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          Add project
        </button>

        <!-- AI helper -->
        <div class="ai-helper" role="region" aria-label="AI Project Assistant">
          <strong>AI Project Assistant</strong>
          <div class="ai-actions">
            <button type="button" class="ai-button" id="generateBtn">🔗 Generate from URL</button>
            <button type="button" class="ai-button" id="enhanceBtn">✨ Enhance Description</button>
          </div>
        </div>

        <!-- Actions -->
        <div class="form-actions">
          <a href="/onboarding/experience" class="btn btn-back" id="backBtn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M19 12H5M12 19l-7-7 7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Back
          </a>

          <button type="submit" class="btn btn-primary" id="continueBtn" disabled>
            <span id="btnText">Continue</span>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M5 12h14M12 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
      </form>
    </section>
  </main>

  <script>
    /* Subtle particle background */
    (() => {
      const canvas = document.getElementById('bgCanvas');
      const ctx = canvas.getContext('2d');
      let w, h, particles = [];
      const COUNT = 30;

      function size(){ w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; }
      size(); window.addEventListener('resize', size);

      class P {
        constructor(init=false){ this.reset(init); }
        reset(init){ this.x = init?Math.random()*w:(Math.random()<0.5?0:w); this.y = Math.random()*h; this.s = Math.random()*2+0.5; this.vx = Math.random()*0.5-0.25; this.vy = Math.random()*0.5-0.25; }
        step(){ this.x+=this.vx; this.y+=this.vy; if (this.x>w||this.x<0||this.y>h||this.y<0) this.reset(); }
        draw(){ ctx.fillStyle='#000'; ctx.beginPath(); ctx.arc(this.x,this.y,this.s,0,Math.PI*2); ctx.fill(); }
      }
      for (let i=0;i<COUNT;i++) particles.push(new P(true));

      function tick(){
        ctx.clearRect(0,0,w,h);
        particles.forEach(p=>{ p.step(); p.draw(); });
        for(let i=0;i<particles.length;i++){
          for(let j=i+1;j<particles.length;j++){
            const a=particles[i], b=particles[j];
            const d=Math.hypot(a.x-b.x, a.y-b.y);
            if(d<100){ ctx.strokeStyle=`rgba(0,0,0,${1-d/100})`; ctx.lineWidth=0.3; ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke(); }
          }
        }
        requestAnimationFrame(tick);
      }
      if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) tick();
    })();
  </script>

  <script>
    /* ===== Portfolio Projects with Image Upload ===== */
    (() => {
      "use strict";

      // DOM
      const projectsList = document.getElementById('projectsList');
      const emptyState = document.getElementById('emptyState');
      const addBtn = document.getElementById('addBtn');
      const continueBtn = document.getElementById('continueBtn');
      const btnText = document.getElementById('btnText');
      const generateBtn = document.getElementById('generateBtn');
      const enhanceBtn = document.getElementById('enhanceBtn');
      const skipBtn = document.getElementById('skipBtn');
      const stepText = document.getElementById('stepText');
      const headerProgress = document.getElementById('headerProgress');
      const formEl = document.getElementById('portfolioForm');

      // Progress
      const CURRENT_STEP = 5, TOTAL_STEPS = 8;
      function updateProgress(step){
        const pct = (step / TOTAL_STEPS) * 100;
        headerProgress.style.width = pct + '%';
        stepText.textContent = `Step ${step} of ${TOTAL_STEPS}`;
      }

      // State
      /** @type {{id:number, title:string, description:string, link:string, image?:string}[]} */
      let projects = [];
      let projectIdCounter = 0;
      let editingId = null;

      // Limits
      const TITLE_MAX = 80;
      const DESC_MAX  = 280;
      const FILE_MAX_MB = 6;       // raw upload limit (we still compress)
      const IMG_MAX_W = 1600;      // resize bound
      const IMG_MAX_H = 1200;
      const IMG_QUALITY = 0.86;    // 0..1

      // Utils
      const esc = (s) => String(s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
      const normURL = (url='') => { const v = String(url).trim(); if (!v) return ''; if (/^https?:\/\//i.test(v)) return v; return 'https://' + v.replace(/^\/+/, ''); };
      const hostnameFrom = (url) => { try { return new URL(normURL(url)).hostname.replace(/^www\./,''); } catch { return ''; } };

      function toast(msg){
        const t = document.createElement('div');
        t.className = 'toast';
        t.textContent = msg;
        document.body.appendChild(t);
        setTimeout(()=>{ t.style.opacity='0'; t.style.transform='translateY(-6px)'; setTimeout(()=> t.remove(), 200); }, 2200);
      }

      // Storage
      function saveAll(){
        try {
          const data = projects.filter(p => (p.title || p.description || p.link || p.image));
          localStorage.setItem('onboarding_portfolio', JSON.stringify(data));
        } catch {}
      }
      function loadAll(){
        try {
          const raw = localStorage.getItem('onboarding_portfolio');
          if (!raw) return;
          const arr = JSON.parse(raw);
          if (Array.isArray(arr)) {
            projects = arr.map(p => ({
              id: Number(p?.id) || ++projectIdCounter,
              title: String(p?.title || ''),
              description: String(p?.description || ''),
              link: String(p?.link || ''),
              image: p?.image || ''
            }));
            projectIdCounter = projects.reduce((m,p)=> Math.max(m, p.id), projectIdCounter);
          }
        } catch {}
      }

      // Rendering
      function render(){
        projectsList.innerHTML = '';
        if (projects.length === 0) {
          emptyState.style.display = 'block';
          projectsList.appendChild(emptyState);
          updateContinueState();
          saveAll();
          return;
        }
        emptyState.style.display = 'none';
        projects.forEach(p => {
          const html = (editingId === p.id) ? renderEdit(p) : renderCard(p);
          projectsList.insertAdjacentHTML('beforeend', html);
        });
        updateContinueState();
        saveAll();
      }

      function renderCard(p){
        const link = p.link ? normURL(p.link) : '';
        const hasLink = !!link;
        const hasImg = !!p.image;
        return `
          <div class="project-card display-card" id="proj-${p.id}">
            <div class="card-actions">
              <button type="button" class="card-edit" title="Edit" onclick="editProject(${p.id})" aria-label="Edit project">✎</button>
              <button type="button" class="card-remove" title="Remove" onclick="removeProject(${p.id})" aria-label="Remove project">×</button>
            </div>

            ${hasImg ? `
              <div class="card-media">
                <div class="media-wrap"><img src="${p.image}" alt="${esc(p.title || 'Project image')}" loading="lazy"></div>
              </div>` : ''}

            <div class="card-header">
              <div class="card-title">${esc(p.title) || 'Untitled project'}</div>
            </div>

            ${p.description ? `<div class="card-description">${esc(p.description)}</div>` : ''}

            <div class="card-footer">
              ${hasLink ? `<a class="card-link" href="${link}" target="_blank" rel="noopener">View project →</a>`
                        : `<span class="card-link" style="opacity:.6;pointer-events:none;">No link added</span>`}
              ${hasLink ? `<span class="card-tech">${esc(hostnameFrom(link))}</span>` : `<span></span>`}
            </div>
          </div>
        `;
      }

      function renderEdit(p){
        const hasImg = !!p.image;
        return `
          <div class="project-card edit-card" id="proj-${p.id}">
            <div class="form-header-actions">
              <button type="button" class="save-btn" onclick="saveProject(${p.id})">✓ Save</button>
              <button type="button" class="cancel-btn" onclick="cancelEdit(${p.id})">Cancel</button>
            </div>

            <div class="form-group">
              <label class="form-label">Project title <span class="required">*</span></label>
              <input class="form-input" maxlength="${TITLE_MAX}" data-id="${p.id}" data-field="title"
                     value="${esc(p.title)}" placeholder="e.g., Analytics Dashboard for E-commerce"/>
              <div class="char-count" id="ct-title-${p.id}">${(p.title||'').length}/${TITLE_MAX}</div>
            </div>

            <div class="form-group">
              <label class="form-label">Short description <span class="required">*</span></label>
              <textarea class="form-textarea" maxlength="${DESC_MAX}" data-id="${p.id}" data-field="description"
                        placeholder="What was the goal, what did you build, and what was the impact?">${esc(p.description)}</textarea>
              <div class="char-count" id="ct-desc-${p.id}">${(p.description||'').length}/${DESC_MAX}</div>
            </div>

            <div class="form-group">
              <label class="form-label">Project link (optional)</label>
              <input class="form-input" data-id="${p.id}" data-field="link" value="${esc(p.link)}" placeholder="https://example.com/project"/>
            </div>

            <div class="form-group">
              <label class="form-label">Cover image (optional)</label>
              <div class="img-dropzone" data-id="${p.id}">
                <div class="dz-inner">
                  <div class="img-thumb">
                    ${hasImg ? `<img src="${p.image}" alt="Preview">` : `No image`}
                  </div>
                  <div>
                    <div class="img-actions">
                      <button type="button" class="img-btn img-upload-btn" data-id="${p.id}">Upload image</button>
                      ${hasImg ? `<button type="button" class="img-btn img-remove-btn" data-id="${p.id}">Remove</button>` : ``}
                    </div>
                    <div class="img-hint">PNG/JPG/WebP • up to ${FILE_MAX_MB}MB • we’ll resize and optimize automatically</div>
                  </div>
                </div>
                <input class="img-input" data-id="${p.id}" type="file" accept="image/*" hidden />
              </div>
            </div>
          </div>
        `;
      }

      // CRUD
      function addProject(){
        const id = ++projectIdCounter;
        projects.unshift({ id, title:'', description:'', link:'', image:'' });
        editingId = id;
        render();
        setTimeout(() => {
          const first = document.querySelector(`#proj-${id} .form-input[data-field="title"]`);
          if (first) first.focus();
        }, 60);
      }
      function editProject(id){ editingId = id; render(); }
      function removeProject(id){
        projects = projects.filter(p => p.id !== id);
        if (editingId === id) editingId = null;
        render();
      }
      function cancelEdit(id){
        const p = projects.find(x => x.id === id);
        if (p && !p.title && !p.description && !p.link && !p.image) { removeProject(id); }
        else { editingId = null; render(); }
      }
      function saveProject(id){
        const p = projects.find(x => x.id === id);
        if (!p) return;
        if (!p.title.trim() || !p.description.trim()){
          alert('Please fill in both title and description.');
          return;
        }
        p.link = normURL(p.link);
        editingId = null;
        saveAll();
        render();
      }

      // Update field (no re-render)
      function updateProjectField(id, field, value){
        const p = projects.find(x => x.id === id);
        if (!p) return;
        if (field === 'title')        p.title = value.slice(0, TITLE_MAX);
        else if (field === 'description') p.description = value.slice(0, DESC_MAX);
        else if (field === 'link')    p.link = value.trim();
      }

      // Image processing
      function isImageFile(file){ return file && file.type && file.type.startsWith('image/'); }

      function readAsImage(file){
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => {
            const img = new Image();
            img.onload = () => resolve(img);
            img.onerror = reject;
            img.src = reader.result;
          };
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      async function compressImage(file, maxW=IMG_MAX_W, maxH=IMG_MAX_H, quality=IMG_QUALITY){
        const img = await readAsImage(file);
        let { width:w, height:h } = img;

        // scale down preserving aspect
        const ratio = Math.min(1, maxW / w, maxH / h);
        const cw = Math.round(w * ratio);
        const ch = Math.round(h * ratio);

        const canvas = document.createElement('canvas');
        canvas.width = cw;
        canvas.height = ch;
        const ctx = canvas.getContext('2d');

        // crisp downscale
        ctx.imageSmoothingQuality = 'high';
        ctx.drawImage(img, 0, 0, cw, ch);

        // prefer webp when available
        let mime = 'image/webp';
        let dataUrl = canvas.toDataURL(mime, quality);
        if (!dataUrl.startsWith('data:image/webp')) {
          mime = 'image/jpeg';
          dataUrl = canvas.toDataURL(mime, quality);
        }
        return dataUrl;
      }

      async function handlePickedFile(id, file){
        if (!isImageFile(file)) { toast('Please choose a valid image.'); return; }
        if (file.size > FILE_MAX_MB * 1024 * 1024) { toast(`Image is larger than ${FILE_MAX_MB}MB. Compressing…`); }
        try {
          const dataUrl = await compressImage(file);
          const p = projects.find(x => x.id === id);
          if (p) {
            p.image = dataUrl;
            saveAll();
            render();
            toast('Image added');
          }
        } catch {
          toast('Could not process that image.');
        }
      }

      function removeImage(id){
        const p = projects.find(x => x.id === id);
        if (!p) return;
        p.image = '';
        saveAll();
        render();
        toast('Image removed');
      }

      // Delegated inputs
      projectsList.addEventListener('input', (e) => {
        const el = e.target;
        if (!el.dataset?.field) return;
        const id = Number(el.dataset.id);
        const field = el.dataset.field;
        let value = el.value;

        updateProjectField(id, field, value);

        // live counters
        if (field === 'title') {
          const ct = document.getElementById(`ct-title-${id}`);
          if (ct) ct.textContent = `${projects.find(p=>p.id===id)?.title.length || 0}/${TITLE_MAX}`;
        }
        if (field === 'description') {
          const ct = document.getElementById(`ct-desc-${id}`);
          if (ct) ct.textContent = `${projects.find(p=>p.id===id)?.description.length || 0}/${DESC_MAX}`;
        }
        saveAll();
      });

      projectsList.addEventListener('blur', (e) => {
        const el = e.target;
        if (el.dataset?.field === 'link') {
          const id = Number(el.dataset.id);
          const p = projects.find(x => x.id === id);
          if (p) {
            p.link = normURL(p.link);
            el.value = p.link;
            saveAll();
          }
        }
      }, true);

      projectsList.addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 's') {
          e.preventDefault();
          if (editingId != null) saveProject(editingId);
        }
      });

      // Image UI: clicks + file input
      projectsList.addEventListener('click', (e) => {
        const upBtn = e.target.closest('.img-upload-btn');
        if (upBtn){
          const id = Number(upBtn.dataset.id);
          const dz = projectsList.querySelector(`.img-dropzone[data-id="${id}"]`);
          const input = dz?.querySelector('.img-input');
          if (input) input.click();
          return;
        }
        const rmBtn = e.target.closest('.img-remove-btn');
        if (rmBtn){
          removeImage(Number(rmBtn.dataset.id));
          return;
        }
      });

      // Handle file selection
      projectsList.addEventListener('change', async (e) => {
        const input = e.target.closest('.img-input');
        if (!input) return;
        const id = Number(input.dataset.id);
        const file = input.files && input.files[0];
        if (file) await handlePickedFile(id, file);
        // reset so same file can be picked again
        input.value = '';
      });

      // Drag & drop
      projectsList.addEventListener('dragover', (e) => {
        const dz = e.target.closest('.img-dropzone');
        if (!dz) return;
        e.preventDefault();
        dz.classList.add('dragover');
      });
      projectsList.addEventListener('dragleave', (e) => {
        const dz = e.target.closest('.img-dropzone');
        if (!dz) return;
        dz.classList.remove('dragover');
      });
      projectsList.addEventListener('drop', async (e) => {
        const dz = e.target.closest('.img-dropzone');
        if (!dz) return;
        e.preventDefault();
        dz.classList.remove('dragover');
        const id = Number(dz.dataset.id);
        const file = e.dataTransfer?.files?.[0];
        if (file) await handlePickedFile(id, file);
      });

      // AI helpers (simulated)
      function generateFromURL(){
        generateBtn.disabled = true;
        const prev = generateBtn.innerHTML;
        generateBtn.innerHTML = '<span class="loading-spinner"></span>';

        const ensureEdit = () => {
          if (editingId != null) return editingId;
          if (projects.length === 0){ addProject(); return editingId; }
          editingId = projects[0].id; render(); return editingId;
        };

        setTimeout(() => {
          const id = ensureEdit();
          const linkInput = document.querySelector(`#proj-${id} .form-input[data-field="link"]`);
          let url = (linkInput && linkInput.value.trim()) || prompt('Paste a project URL to extract details:','https://');
          if (!url){ generateBtn.disabled = false; generateBtn.innerHTML = prev; return; }

          url = normURL(url);
          if (linkInput) linkInput.value = url;
          updateProjectField(id, 'link', url);

          const host = hostnameFrom(url) || 'Your Site';
          const baseTitle = host.split('.')[0].replace(/[-_]/g, ' ').replace(/\b\w/g, m => m.toUpperCase());
          const p = projects.find(x => x.id === id);
          if (p) {
            if (!p.title) p.title = `${baseTitle} – Project`;
            if (!p.description) p.description = `Designed and built a responsive ${baseTitle.toLowerCase()} experience. Implemented optimized UI and analytics, improving engagement by ~25%.`;
          }
          saveAll();
          render();
          generateBtn.disabled = false;
          generateBtn.innerHTML = prev;
        }, 800);
      }

      function enhanceDescription(){
        if (projects.length === 0) { addProject(); return; }
        enhanceBtn.disabled = true;
        const prev = enhanceBtn.innerHTML;
        enhanceBtn.innerHTML = '<span class="loading-spinner"></span>';

        const id = editingId ?? projects[0].id;

        setTimeout(() => {
          const p = projects.find(x => x.id === id);
          if (p) {
            const base = (p.description || '').trim();
            const improved = base
              ? `${base.replace(/\.*\s*$/,'')}. Results: cut load time by 35%, increased conversions by 18%, improved accessibility to AA.`
              : `Led end-to-end delivery: scoped requirements, designed UI, built features, and shipped on time. Results: +18% conversions, −35% load time, AA accessibility.`;
            p.description = improved.slice(0, DESC_MAX);
            saveAll();
            render();
          }
          enhanceBtn.disabled = false;
          enhanceBtn.innerHTML = prev;
        }, 700);
      }

      // Continue / nav
      function updateContinueState(){ continueBtn.disabled = (editingId != null); }
      function advanceToNextStep(){
        btnText.innerHTML = '<span class="loading-spinner"></span>';
        continueBtn.disabled = true;
        updateProgress(CURRENT_STEP + 1);
        setTimeout(() => {
          try { window.location.href = '/onboarding/education'; }
          catch { alert('Saved! Moving to Education…'); }
        }, 700);
      }

      addBtn.addEventListener('click', addProject);
      generateBtn.addEventListener('click', generateFromURL);
      enhanceBtn.addEventListener('click', enhanceDescription);
      skipBtn.addEventListener('click', () => advanceToNextStep());

      formEl.addEventListener('submit', (e) => {
        e.preventDefault();
        if (editingId != null){
          const ok = confirm('You have unsaved changes. Discard and continue?');
          if (!ok) return;
        }
        saveAll();
        advanceToNextStep();
      });

      // Expose minimal handlers
      window.editProject = editProject;
      window.removeProject = removeProject;
      window.saveProject = saveProject;
      window.cancelEdit = cancelEdit;

      // Init
      document.addEventListener('DOMContentLoaded', () => {
        updateProgress(CURRENT_STEP);
        loadAll();
        render();
      });
    })();
  </script>
</body>
</html>
