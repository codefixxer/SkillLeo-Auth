<!-- page 4 -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Work Experience - ProMatch</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root {
      --primary: #0061FF;
      --dark: #000000;
      --gray-900: #111111;
      --gray-700: #404040;
      --gray-500: #737373;
      --gray-300: #E5E7EB;
      --gray-100: #F9FAFB;
      --white: #FFFFFF;
      --error: #EF4444;
      --success: #10B981;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      color: var(--gray-900);
      background: var(--white);
      -webkit-font-smoothing: antialiased;
      line-height: 1.5;
      position: relative;
      overflow-x: hidden;
    }

    /* Background canvas */
    .bg-canvas {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      opacity: 0.02;
    }

    /* Floating blobs + starfield */
    .bg-decoration { position: fixed; inset: 0; width: 100%; height: 100%; pointer-events: none; z-index: -2; }
    .floating-shape {
      position: absolute; border-radius: 50%; will-change: transform, opacity; filter: blur(6px);
      background:
        radial-gradient(circle at 30% 30%, rgba(0, 97, 255, 0.22), rgba(0, 97, 255, 0.10) 45%, transparent 65%),
        radial-gradient(circle at 70% 70%, rgba(0, 97, 255, 0.18), transparent 60%);
      animation: floatBlob 14s ease-in-out infinite; opacity: 0.6;
    }
    .floating-shape:nth-child(1){ --size:300px; width:var(--size); height:var(--size); top:10%; right:10%; animation-delay:0s; }
    .floating-shape:nth-child(2){ --size:220px; width:var(--size); height:var(--size); bottom:18%; left:6%; animation-delay:4.2s; }
    .floating-shape:nth-child(3){ --size:160px; width:var(--size); height:var(--size); top:52%; right:28%; animation-delay:8.4s; }
    .bg-decoration::after {
      content:""; position:absolute; inset:-10%; opacity:.5; background-repeat:no-repeat;
      background-image:
        radial-gradient(1.5px 1.5px at 8% 15%,  rgba(0, 97, 255, 0.14) 99%, transparent 100%),
        radial-gradient(1.6px 1.6px at 18% 70%, rgba(0, 97, 255, 0.10) 99%, transparent 100%),
        radial-gradient(1.4px 1.4px at 28% 35%, rgba(0, 97, 255, 0.12) 99%, transparent 100%),
        radial-gradient(1.5px 1.5px at 42% 82%, rgba(0, 97, 255, 0.09) 99%, transparent 100%),
        radial-gradient(1.6px 1.6px at 56% 22%, rgba(0, 97, 255, 0.13) 99%, transparent 100%),
        radial-gradient(1.5px 1.5px at 68% 58%, rgba(0, 97, 255, 0.11) 99%, transparent 100%),
        radial-gradient(1.4px 1.4px at 78% 28%, rgba(0, 97, 255, 0.10) 99%, transparent 100%),
        radial-gradient(1.6px 1.6px at 88% 66%, rgba(0, 97, 255, 0.12) 99%, transparent 100%);
      animation: starDrift 60s linear infinite;
    }
    @keyframes floatBlob { 0%,100%{transform:translate3d(0,0,0) scale(1) rotate(0deg); opacity:.55;}
      25%{transform:translate3d(-12px,-24px,0) scale(1.03) rotate(8deg); opacity:.65;}
      50%{transform:translate3d(0,-14px,0) scale(.98) rotate(0); opacity:.60;}
      75%{transform:translate3d(12px,-28px,0) scale(1.04) rotate(-8deg); opacity:.68;} }
    @keyframes starDrift { 0%{transform:translate3d(0,0,0);} 100%{transform:translate3d(-80px,-60px,0);} }
    @media (prefers-reduced-motion: reduce){ .floating-shape, .bg-decoration::after{ animation:none !important; } }

    /* Header */
    .header { position: fixed; top: 0; left: 0; right: 0; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--gray-300); z-index: 100; }
    .header__inner { max-width: 1200px; margin: 0 auto; padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; min-height: 64px; }
    .logo { height: 28px; width: auto; display: block; }
    .progress-container { display:flex; align-items:center; gap:12px; font-size:13px; color:var(--gray-500); font-weight:500; }
    .progress-bar { width: 120px; height: 6px; background: var(--gray-300); border-radius: 3px; overflow: hidden; }
    .progress-fill { height:100%; background: var(--dark); transition: width .6s ease; width: 50%; }

    /* Card */
    .container { max-width: 640px; margin: 0 auto; padding: 100px 24px 40px; min-height: 100vh; display: flex; align-items: center; }
    .form-card { width:100%; background:rgba(255,255,255,0.98); backdrop-filter:blur(20px); border:1px solid var(--gray-300);
      border-radius:16px; padding:40px; box-shadow:0 10px 40px rgba(0,0,0,0.03); animation:slideUp .6s ease-out; }
    @keyframes slideUp { from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:none;} }
    .form-header { margin-bottom: 32px; }
    .step-badge{ display:inline-flex; align-items:center; gap:6px; padding:6px 14px; background:var(--gray-100); color:var(--gray-700);
      border-radius:20px; font-size:13px; font-weight:500; margin-bottom:16px; }
    .step-badge::before{ content:''; width:6px; height:6px; background:var(--primary); border-radius:50%; animation:pulse 2s ease-in-out infinite; }
    @keyframes pulse{ 0%,100%{opacity:1} 50%{opacity:.5} }
    .form-title{ font-size:28px; font-weight:700; color:var(--dark); margin-bottom:8px; letter-spacing:-0.02em; }
    .form-subtitle{ font-size:15px; color:var(--gray-500); }

    /* Experience list */
    .experience-list { margin: 24px 0; }
    .empty-state { border:2px dashed var(--gray-300); border-radius:12px; padding:28px; text-align:center; color:var(--gray-500); font-size:14px; }

    .experience-card{ border:1px solid var(--gray-300); border-radius:12px; padding:20px; background:var(--white); box-shadow:0 6px 20px rgba(0,0,0,0.03);
      position:relative; margin-bottom:14px; transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease; }
    .experience-card:hover{ transform:translateY(-1px); box-shadow:0 10px 28px rgba(0,0,0,0.06); }

    .card-actions{ position:absolute; top:10px; right:10px; display:flex; gap:8px; z-index:2; background:rgba(255,255,255,0.8);
      border:1px solid var(--gray-300); border-radius:10px; backdrop-filter:blur(6px); padding:4px; }
    .icon-btn{ width:30px; height:30px; display:inline-flex; align-items:center; justify-content:center; border:1px solid var(--gray-300);
      background:var(--white); border-radius:8px; cursor:pointer; transition:background .2s ease, color .2s ease, transform .15s ease, border-color .2s ease; }
    .icon-btn:hover{ transform: translateY(-1px); }
    .btn-edit:hover{ background:var(--dark); color:#fff; border-color:var(--dark); }
    .btn-remove{ border-radius:50%; color:#DC2626; background:#FEE2E2; border-color:#FCA5A5; }
    .btn-remove:hover{ background:#DC2626; color:#fff; border-color:#DC2626; }

    .card-header{ padding-right:96px; }
    .card-company{ font-weight:700; color:var(--gray-900); font-size:16px; margin-bottom:2px; }
    .card-title{ font-weight:600; color:var(--gray-700); font-size:14px; margin-bottom:6px; }
    .card-date{ font-size:13px; color:var(--gray-500); }
    .card-description{ margin-top:12px; padding-top:12px; border-top:1px solid var(--gray-300); font-size:14px; color:var(--gray-700); }

    .edit-card{ border:1px solid var(--dark); }
    .form-grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .form-group{ margin-bottom:16px; }
    .form-label{ display:block; font-size:14px; font-weight:500; color:var(--gray-700); margin-bottom:8px; }
    .required{ color:var(--error); }

    .form-input,.form-select,.form-textarea{
      width:100%; padding:12px 14px; border:1px solid var(--gray-300); border-radius:8px; font-size:15px; font-family:inherit;
      background:var(--white); transition:all .2s ease; min-height:44px;
    }
    .form-input:focus,.form-select:focus,.form-textarea:focus{ outline:none; border-color:var(--dark); box-shadow:0 0 0 3px rgba(0,0,0,0.05); }
    .form-textarea{ resize:vertical; min-height:96px; line-height:1.6; }

    .date-grid{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .current-role{ display:flex; align-items:center; gap:8px; font-size:14px; color:var(--gray-700); margin-top:8px; }
    .current-role input{ width:16px; height:16px; accent-color:var(--dark); }

    .char-count{ text-align:right; font-size:12px; color:var(--gray-500); margin-top:6px; }

    .add-experience-btn{
      width:100%; padding:12px 16px; border-radius:10px; border:1px dashed var(--gray-300); background:var(--gray-100);
      color:var(--gray-700); font-weight:600; display:flex; align-items:center; justify-content:center; gap:8px; transition:all .2s ease; margin-top:12px;
    }
    .add-experience-btn:hover{ background:#EEF2FF; border-color:var(--dark); color:var(--dark); transform:translateY(-1px); }

    .tips{ margin-top:16px; padding:14px; background:rgba(16,185,129,0.08); border:1px solid rgba(16,185,129,0.3); border-radius:8px; color:var(--gray-700); font-size:13px; }
    .tips strong{ color:var(--success); }

    .form-actions{ display:flex; justify-content:space-between; align-items:center; margin-top:28px; padding-top:20px; border-top:1px solid var(--gray-300); }
    .btn{ padding:12px 24px; border-radius:8px; font-weight:500; font-size:15px; cursor:pointer; border:none; text-decoration:none; display:inline-flex; align-items:center; gap:8px; transition:all .2s ease; font-family:inherit; }
    .btn svg{ display:block; }
    .btn-back{ background:var(--white); color:var(--gray-700); border:1px solid var(--gray-300); }
    .btn-back:hover{ border-color:var(--gray-700); background:var(--gray-100); }
    .btn-primary{ background:var(--dark); color:#fff; min-width:120px; justify-content:center; }
    .btn-primary:hover:not(:disabled){ transform:translateY(-1px); box-shadow:0 4px 12px rgba(0,0,0,0.15); }
    .btn-primary:disabled{ opacity:.3; cursor:not-allowed; }
    .loading-spinner{ width:16px; height:16px; border:2px solid transparent; border-top:2px solid currentColor; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin{ to{ transform:rotate(360deg);} }

    .sr-only{ position:absolute !important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,1px,1px); white-space:nowrap; border:0; }

    @media (max-width: 640px){
      .container{ padding:80px 16px 24px; }
      .form-card{ padding:32px 24px; }
      .form-title{ font-size:24px; }
      .form-actions{ flex-direction:column-reverse; gap:12px; }
      .btn{ width:100%; justify-content:center; }
      .form-grid,.date-grid{ grid-template-columns:1fr; }
      .floating-shape{ opacity:.05; }
      .card-header{ padding-right:76px; }
    }
  </style>
</head>
<body>
  <!-- Background -->
  <canvas class="bg-canvas" id="bgCanvas" aria-hidden="true"></canvas>
  <div class="bg-decoration" aria-hidden="true">
    <div class="floating-shape"></div>
    <div class="floating-shape"></div>
    <div class="floating-shape"></div>
  </div>

  <!-- Header -->
  <header class="header">
    <div class="header__inner">
      <picture>
        <source media="(max-width: 768px)" srcset="../logos/rm-bg/icon1.png"/>
        <img class="logo" src="../logos/rm-bg/logo1.png" alt="ProMatch"/>
      </picture>

      <div class="progress-container" aria-live="polite">
        <span id="stepText">Step 4 of 8</span>
        <div class="progress-bar" aria-hidden="true">
          <div class="progress-fill" id="headerProgress"></div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="container">
    <section class="form-card" aria-labelledby="exp-title">
      <div class="form-header">
        <div class="step-badge">Work Experience</div>
        <h1 class="form-title" id="exp-title">Your professional journey</h1>
        <p class="form-subtitle">Add roles that highlight your responsibilities and impact.</p>
      </div>

      <form id="experienceForm" novalidate>
        <div class="experience-list" id="experienceList">
          <div class="empty-state" id="emptyState">Start with your most recent role.</div>
        </div>

        <button type="button" class="add-experience-btn" id="addBtn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          Add experience
        </button>

        <div class="tips">
          <strong>Pro tip:</strong> Use strong verbs and add metrics (e.g., “Reduced costs by 18%”). Keep 2–4 bullet points per role.
        </div>

        <div class="form-actions">
          <a href="/onboarding/skills" class="btn btn-back" id="backBtn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M19 12H5M12 19l-7-7 7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Back
          </a>

          <button type="submit" class="btn btn-primary" id="continueBtn" disabled>
            <span id="btnText">Continue</span>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M5 12h14M12 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
      </form>
    </section>
  </main>

  <script>
    /* Particle background */
    (() => {
      const canvas = document.getElementById('bgCanvas');
      const ctx = canvas.getContext('2d');
      let w, h, particles = [];
      const COUNT = 30;

      function size(){ w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; }
      size(); window.addEventListener('resize', size);

      class P {
        constructor(init=false){ this.reset(init); }
        reset(init){
          this.x = init ? Math.random()*w : (Math.random()<0.5?0:w);
          this.y = Math.random()*h;
          this.s = Math.random()*2 + 0.5;
          this.vx = Math.random()*0.5 - 0.25;
          this.vy = Math.random()*0.5 - 0.25;
        }
        step(){ this.x+=this.vx; this.y+=this.vy; if (this.x>w||this.x<0||this.y>h||this.y<0) this.reset(); }
        draw(){ ctx.fillStyle='#000'; ctx.beginPath(); ctx.arc(this.x,this.y,this.s,0,Math.PI*2); ctx.fill(); }
      }
      for (let i=0;i<COUNT;i++) particles.push(new P(true));

      function tick(){
        ctx.clearRect(0,0,w,h);
        particles.forEach(p=>{ p.step(); p.draw(); });
        for(let i=0;i<particles.length;i++){
          for(let j=i+1;j<particles.length;j++){
            const a=particles[i], b=particles[j];
            const d=Math.hypot(a.x-b.x, a.y-b.y);
            if(d<100){ ctx.strokeStyle=`rgba(0,0,0,${1-d/100})`; ctx.lineWidth=0.3; ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke(); }
          }
        }
        requestAnimationFrame(tick);
      }
      if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) tick();
    })();
  </script>

  <script>
    /* Work Experience – no more input blur on typing */
    (() => {
      "use strict";

      const listEl = document.getElementById('experienceList');
      const emptyEl = document.getElementById('emptyState');
      const addBtn = document.getElementById('addBtn');
      const continueBtn = document.getElementById('continueBtn');
      const btnText = document.getElementById('btnText');
      const headerProgress = document.getElementById('headerProgress');
      const stepText = document.getElementById('stepText');
      const formEl = document.getElementById('experienceForm');

      const CURRENT_STEP = 4;
      const TOTAL_STEPS = 8;
      const NEXT_STEP_URL = '/onboarding/portfolio';

      let experiences = [];
      let editingId = null;
      let counter = 0;

      const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      const currentYear = new Date().getFullYear();
      const years = Array.from({length: 40}, (_,i)=> currentYear - i);

      const esc = (s) => String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
      const saveAll = () => { try { localStorage.setItem('onboarding_experience', JSON.stringify(experiences)); } catch{} };
      function loadAll(){
        try{
          const raw = localStorage.getItem('onboarding_experience');
          if(!raw) return;
          const parsed = JSON.parse(raw);
          if(Array.isArray(parsed)){
            experiences = parsed.map(x=>({
              id:Number(x?.id)||++counter,
              company:String(x?.company||''),
              title:String(x?.title||''),
              startMonth:String(x?.startMonth||''),
              startYear:String(x?.startYear||''),
              endMonth:String(x?.endMonth||''),
              endYear:String(x?.endYear||''),
              current:!!x?.current,
              description:String(x?.description||''),
            }));
            counter = experiences.reduce((m,e)=>Math.max(m,e.id), counter);
          }
        }catch{}
      }

      function updateProgress(step){
        headerProgress.style.width = ((step / TOTAL_STEPS) * 100) + '%';
        stepText.textContent = `Step ${step} of ${TOTAL_STEPS}`;
      }

      function setContinueEnabled(on){
        const was = continueBtn.disabled;
        continueBtn.disabled = !on;
        if (on && was) {
          continueBtn.style.transform = 'scale(1.02)';
          setTimeout(()=> continueBtn.style.transform = '', 180);
        }
      }

      function formatDate(month, year){
        if (!month || !year) return '';
        return `${months[Number(month)-1]} ${year}`;
      }
      function formatDateRange(exp){
        const start = formatDate(exp.startMonth, exp.startYear);
        const end = exp.current ? 'Present' : formatDate(exp.endMonth, exp.endYear);
        if (!start) return '';
        return end && end!==start ? `${start} — ${end}` : start;
      }

      /* RENDER ONLY when adding/removing/switching view. Do NOT render on each keystroke. */
      function render(){
        if (experiences.length === 0) {
          emptyEl.style.display = 'block';
          listEl.innerHTML = '';
          saveAll();
          return;
        }
        emptyEl.style.display = 'none';
        listEl.innerHTML = experiences.map(exp => (editingId === exp.id ? renderEdit(exp) : renderDisplay(exp))).join('');
        saveAll();
      }

      function renderDisplay(exp){
        return `
          <div class="experience-card" id="exp-${exp.id}">
            <div class="card-actions">
              <button type="button" class="icon-btn btn-edit" aria-label="Edit" onclick="editExperience(${exp.id})">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M11 4H5a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M18.5 2.5a2.12 2.12 0 1 1 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
              <button type="button" class="icon-btn btn-remove" aria-label="Remove" onclick="removeExperience(${exp.id})">×</button>
            </div>
            <div class="card-header">
              <div class="card-company">${esc(exp.company || 'Company name')}</div>
              <div class="card-title">${esc(exp.title || 'Job title')}</div>
              <div class="card-date">${esc(formatDateRange(exp))}</div>
            </div>
            ${exp.description ? `<div class="card-description">${esc(exp.description)}</div>` : '' }
          </div>
        `;
      }

      function renderEdit(exp){
        return `
          <div class="experience-card edit-card" id="exp-${exp.id}">
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">Company <span class="required">*</span></label>
                <input type="text" class="form-input" placeholder="Company name" value="${esc(exp.company)}"
                  oninput="updateExperience(${exp.id}, 'company', this.value)"/>
              </div>
              <div class="form-group">
                <label class="form-label">Job title <span class="required">*</span></label>
                <input type="text" class="form-input" placeholder="Your role" value="${esc(exp.title)}"
                  oninput="updateExperience(${exp.id}, 'title', this.value)"/>
              </div>
            </div>

            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">Start date</label>
                <div class="date-grid">
                  <select class="form-select" onchange="updateExperience(${exp.id}, 'startMonth', this.value)">
                    <option value="">Month</option>
                    ${months.map((m,i)=> `<option value="${i+1}" ${String(exp.startMonth)==String(i+1)?'selected':''}>${m}</option>`).join('')}
                  </select>
                  <select class="form-select" onchange="updateExperience(${exp.id}, 'startYear', this.value)">
                    <option value="">Year</option>
                    ${years.map(y=> `<option value="${y}" ${String(exp.startYear)==String(y)?'selected':''}>${y}</option>`).join('')}
                  </select>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">End date</label>
                <div class="date-grid">
                  <select class="form-select end-month" ${exp.current?'disabled':''} onchange="updateExperience(${exp.id}, 'endMonth', this.value)">
                    <option value="">Month</option>
                    ${months.map((m,i)=> `<option value="${i+1}" ${String(exp.endMonth)==String(i+1)?'selected':''}>${m}</option>`).join('')}
                  </select>
                  <select class="form-select end-year" ${exp.current?'disabled':''} onchange="updateExperience(${exp.id}, 'endYear', this.value)">
                    <option value="">Year</option>
                    ${years.map(y=> `<option value="${y}" ${String(exp.endYear)==String(y)?'selected':''}>${y}</option>`).join('')}
                  </select>
                </div>
                <label class="current-role">
                  <input type="checkbox" ${exp.current?'checked':''} onchange="updateExperience(${exp.id}, 'current', this.checked)"/>
                  I currently work here
                </label>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Description (optional)</label>
              <textarea class="form-textarea desc-input" placeholder="Briefly describe responsibilities and achievements…"
                oninput="updateExperience(${exp.id}, 'description', this.value)">${esc(exp.description)}</textarea>
              <div class="char-count" id="char-${exp.id}">${String(exp.description||'').length}/500 characters</div>
            </div>

            <div class="form-actions" style="padding-top: 8px;">
              <button type="button" class="btn btn-back" onclick="cancelEdit(${exp.id})">Cancel</button>
              <button type="button" class="btn btn-primary" onclick="saveExperience(${exp.id})">Save</button>
            </div>
          </div>
        `;
      }

      /* Actions (no re-render on typing) */
      function addExperience(){
        const id = ++counter;
        experiences.unshift({ id, company:'', title:'', startMonth:'', startYear:'', endMonth:'', endYear:'', current:false, description:'' });
        editingId = id;
        render();
        setTimeout(()=>{ const el = document.querySelector(`#exp-${id} input[type="text"]`); if (el) el.focus(); }, 80);
      }
      function editExperience(id){ editingId = id; render(); }
      function removeExperience(id){
        experiences = experiences.filter(e => e.id !== id);
        if (editingId === id) editingId = null;
        render(); validate();
      }
      function cancelEdit(id){
        const e = experiences.find(x => x.id === id);
        if (e && !e.company.trim() && !e.title.trim()) { removeExperience(id); }
        else { editingId = null; render(); }
      }
      function saveExperience(id){
        const e = experiences.find(x => x.id === id);
        if (!e) return;
        if (!e.company.trim() || !e.title.trim()) { alert('Please fill in company and job title.'); return; }
        editingId = null;
        saveAll();
        render();
        validate();
      }

      /* Core fix: update in place, do NOT call render() on input */
      function updateExperience(id, field, value){
        const e = experiences.find(x => x.id === id);
        if (!e) return;

        if (field === 'current') {
          e.current = !!value;
          if (e.current) { e.endMonth=''; e.endYear=''; }
          // Toggle end-date selects in place
          const card = document.getElementById(`exp-${id}`);
          if (card){
            const endMonthSel = card.querySelector('.end-month');
            const endYearSel = card.querySelector('.end-year');
            if (endMonthSel && endYearSel){ endMonthSel.disabled = e.current; endYearSel.disabled = e.current; endMonthSel.value = e.endMonth || ''; endYearSel.value = e.endYear || ''; }
          }
        } else if (field === 'description') {
          e.description = String(value).slice(0, 500);
          // update char count live
          const cc = document.getElementById(`char-${id}`);
          if (cc) cc.textContent = `${e.description.length}/500 characters`;
        } else {
          e[field] = value;
        }

        saveAll();
        validate();
      }

      function validate(){
        const ok = experiences.some(e => e.company.trim() && e.title.trim() && e.startMonth && e.startYear);
        setContinueEnabled(ok);
        return ok;
      }

      formEl.addEventListener('submit', (e) => {
        e.preventDefault();
        if (!validate()) return;
        saveAll();
        btnText.innerHTML = '<div class="loading-spinner"></div>';
        setContinueEnabled(false);
        updateProgress(CURRENT_STEP + 1);
        setTimeout(() => {
          try { window.location.href = NEXT_STEP_URL; }
          catch { alert('Experience saved! Moving to portfolio…'); }
        }, 700);
      });

      // Expose for inline handlers
      window.addExperience = addExperience;
      window.editExperience = editExperience;
      window.removeExperience = removeExperience;
      window.saveExperience = saveExperience;
      window.cancelEdit = cancelEdit;
      window.updateExperience = updateExperience;

      // Boot
      document.addEventListener('DOMContentLoaded', () => {
        updateProgress(CURRENT_STEP);
        loadAll();
        render();
        validate();
      });

      addBtn.addEventListener('click', addExperience);
    })();
  </script>
</body>
</html>
